{% extends "base.html" %}

{% block content %}
<div class="d-flex flex-column flex-sm-row justify-content-between gap-3 mb-4">
  <div>
    <h1 class="h3 fw-bold mb-1">Furniture Inventory</h1>
    <div class="text-secondary">Manage beds, almaris, showcases, and more</div>
  </div>
  <button class="btn btn-primary btn-lg" type="button" data-bs-toggle="modal" data-bs-target="#furnitureModal">
    Add Furniture
  </button>
</div>

<div class="row g-3 align-items-end mb-4">
  <div class="col-12 col-md-8">
    <label class="form-label">Search</label>
    <input id="furnitureSearch" class="form-control form-control-lg" placeholder="Search furniture..." />
  </div>
  <div class="col-12 col-md-4">
    <label class="form-label">Category</label>
    <select id="furnitureCategoryFilter" class="form-select form-select-lg">
      <option value="all">All Categories</option>
      {% for c in furniture_categories %}
        <option value="{{ c.id }}">{{ c.name }}</option>
      {% endfor %}
    </select>
  </div>
</div>

{% if preset_category_id %}
  <input type="hidden" id="presetCategoryId" value="{{ preset_category_id }}" />
{% endif %}

{% if cards|length == 0 %}
  <div class="card p-5 text-center">
    <div class="h5 fw-semibold mb-1">No furniture found</div>
    <div class="text-secondary mb-3">Get started by adding your first furniture item</div>
    <button class="btn btn-primary" type="button" data-bs-toggle="modal" data-bs-target="#furnitureModal">Add Furniture</button>
  </div>
{% else %}
  <div class="row g-3" id="furnitureGrid">
    {% for c in cards %}
      {% set it = c.item %}
      <div class="col-12 col-md-6 col-xl-4 furniture-card"
           data-name="{{ it.name|lower }}"
           data-category-id="{{ it.category_id }}">
        <div class="card hover-elevate">
          {% if it.image_url or it.image_data %}
            <img
              src="{{ it.image_url or it.image_data }}"
              class="card-img-top"
              alt="{{ it.name }}"
              style="height: 180px; object-fit: cover;"
            />
          {% else %}
            <div class="bg-body-tertiary" style="height: 180px;"></div>
          {% endif %}
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <div class="me-3" style="min-width: 0;">
                <div class="fw-semibold fs-5 text-truncate">{{ it.name }}</div>
                <div class="text-secondary small">{{ c.category_name }}</div>
              </div>
              <span class="badge rounded-pill {{ c.badge_class }}">{{ c.badge }}</span>
            </div>

            <div class="small">
              {% if c.sub_category_name %}
                <div class="d-flex justify-content-between py-1">
                  <span class="text-secondary">Type:</span>
                  <span>{{ c.sub_category_name }}</span>
                </div>
              {% endif %}
              <div class="d-flex justify-content-between py-1">
                <span class="text-secondary">Size:</span>
                <span>{{ c.size_label }}</span>
              </div>
              <div class="d-flex justify-content-between py-1">
                <span class="text-secondary">Quantity:</span>
                <span class="fw-semibold">{{ c.total_qty }}</span>
              </div>
              <div class="d-flex justify-content-between py-1">
                <span class="text-secondary">Cost:</span>
                <span>Rs. {{ '{:,}'.format(c.min_cost) }}</span>
              </div>
              <div class="d-flex justify-content-between py-1">
                <span class="text-secondary">Selling:</span>
                <span class="fw-bold text-primary">Rs. {{ '{:,}'.format(c.min_sale) }}</span>
              </div>
            </div>

            <div class="d-flex flex-wrap gap-2 mt-3">
              {% if c.primary_variant_id %}
                <button
                  class="btn btn-outline-secondary flex-grow-1"
                  type="button"
                  data-bs-toggle="modal"
                  data-bs-target="#stockAdjustModal"
                  data-variant-id="{{ c.primary_variant_id }}"
                  data-item-name="{{ it.name }}"
                  data-current-qty="{{ c.total_qty }}"
                  data-inventory-type="FURNITURE_VARIANT"
                >
                  Adjust Stock
                </button>
              {% else %}
                <button class="btn btn-outline-secondary flex-grow-1" type="button" disabled>
                  Adjust Stock
                </button>
              {% endif %}

              <button
                class="btn btn-outline-secondary"
                type="button"
                data-bs-toggle="modal"
                data-bs-target="#furnitureModal"
                data-mode="edit"
                data-item-id="{{ it.id }}"
                data-name="{{ it.name }}"
                data-category-id="{{ it.category_id }}"
                data-sub-category-id="{{ it.sub_category_id or '' }}"
                data-bed-size-id="{{ c.primary_bed_size_id or 'custom' }}"
                data-material-type="{{ it.material_type or 'Wood' }}"
                data-qty-on-hand="{{ c.primary_qty_on_hand }}"
                data-cost-price-pkr="{{ c.primary_cost_price_pkr }}"
                data-sale-price-pkr="{{ c.primary_sale_price_pkr }}"
                data-image-url="{{ it.image_url or '' }}"
                data-notes="{{ it.notes or '' }}"
                aria-label="Edit"
                title="Edit"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16" aria-hidden="true">
                  <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168z"/>
                  <path d="M11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207z"/>
                </svg>
              </button>

              <form method="post" action="/inventory/furniture/{{ it.id }}/delete" class="m-0">
                <button class="btn btn-outline-danger" type="submit">Delete</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
{% endif %}

<div class="modal fade" id="furnitureModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="furnitureModalTitle">Add Furniture</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="/inventory/furniture" enctype="multipart/form-data">
        <input type="hidden" name="item_id" id="furnitureItemId" />
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label">Name</label>
              <input class="form-control form-control-lg" name="name" id="furnitureNameInput" required placeholder="e.g., King Size Bed Set" />
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">Category</label>
              <select class="form-select form-select-lg" name="category_id" id="furnitureCategorySelect" required>
                <option value="">Select category</option>
                {% for c in furniture_categories %}
                  <option value="{{ c.id }}">{{ c.name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">Sub Category (Optional)</label>
              <select class="form-select form-select-lg" name="sub_category_id" id="furnitureSubCategorySelect">
                <option value="">None</option>
                {% for sc in furniture_subcategories %}
                  <option value="{{ sc.id }}" data-parent-id="{{ sc.parent_id }}">{{ sc.name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">Size</label>
              <select class="form-select form-select-lg" name="bed_size_id" id="furnitureSizeSelect" required>
                {% for s in bed_sizes %}
                  <option value="{{ s.id }}">{{ s.label }}</option>
                {% endfor %}
                <option value="custom">Custom Size</option>
              </select>
              <div class="form-text">Choose "Custom Size" for non-standard</div>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">Material</label>
              <select class="form-select form-select-lg" name="material_type" id="furnitureMaterialSelect">
                <option value="Wood">Wood</option>
                <option value="Metal">Metal</option>
                <option value="MDF">MDF</option>
                <option value="Plywood">Plywood</option>
                <option value="Other">Other</option>
              </select>
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label">Quantity</label>
              <input class="form-control form-control-lg" name="qty_on_hand" id="furnitureQtyInput" type="number" min="0" value="0" required />
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label">Cost Price (Rs.)</label>
              <input class="form-control form-control-lg" name="cost_price_pkr" id="furnitureCostInput" type="number" min="0" value="0" required />
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label">Selling Price (Rs.)</label>
              <input class="form-control form-control-lg" name="sale_price_pkr" id="furnitureSaleInput" type="number" min="0" value="0" required />
            </div>

            <div class="col-12">
              <label class="form-label">Notes (Optional)</label>
              <textarea class="form-control" rows="3" name="notes" id="furnitureNotesInput" placeholder="Any additional notes..."></textarea>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">Image (Upload)</label>
              <input class="form-control" type="file" name="furniture_image" id="furnitureImageFile" accept="image/*" />
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">Image URL (Optional)</label>
              <input class="form-control" type="url" name="furniture_image_url" id="furnitureImageUrl" placeholder="https://..." />
              <div class="form-text">If you upload an image, URL is ignored.</div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary btn-lg" id="furnitureSubmitBtn">Add Furniture</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="stockAdjustModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Adjust Stock</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="/inventory/stock/adjust">
        <input type="hidden" name="inventory_type" id="stockAdjustInventoryType" />
        <input type="hidden" name="variant_id" id="stockAdjustVariantId" />
        <div class="modal-body">
          <div class="p-3 rounded-3 bg-body-tertiary mb-3">
            <div class="fw-semibold text-truncate" id="stockAdjustItemName"></div>
            <div class="small text-secondary">
              Current stock: <span class="fw-semibold" id="stockAdjustCurrentQty"></span>
            </div>
          </div>

          <div class="btn-group w-100 mb-3" role="group" aria-label="Stock adjust type">
            <input type="radio" class="btn-check" name="transaction_type" id="stockIn" value="in" autocomplete="off" checked>
            <label class="btn btn-outline-success" for="stockIn">Stock In</label>

            <input type="radio" class="btn-check" name="transaction_type" id="stockOut" value="out" autocomplete="off">
            <label class="btn btn-outline-warning" for="stockOut">Stock Out</label>
          </div>

          <div class="mb-3">
            <label class="form-label">Quantity</label>
            <input class="form-control form-control-lg" id="stockAdjustQty" name="quantity" type="number" min="1" required />
          </div>

          <div class="mb-3">
            <label class="form-label">Notes (Optional)</label>
            <textarea class="form-control" rows="3" name="notes" placeholder="e.g., Sale to customer, Damaged item..."></textarea>
          </div>

          <div class="p-3 rounded-3 d-none" id="stockAdjustPreview"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Update Stock</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  (function () {
    const search = document.getElementById('furnitureSearch');
    const category = document.getElementById('furnitureCategoryFilter');
    const cards = Array.from(document.querySelectorAll('.furniture-card'));

    function applyFilters() {
      const q = (search && search.value || '').toLowerCase().trim();
      const cat = (category && category.value) || 'all';
      for (const el of cards) {
        const name = (el.getAttribute('data-name') || '');
        const c = (el.getAttribute('data-category-id') || '');
        const okName = !q || name.includes(q);
        const okCat = cat === 'all' || c === cat;
        el.style.display = (okName && okCat) ? '' : 'none';
      }
    }

    if (search) search.addEventListener('input', applyFilters);
    if (category) category.addEventListener('change', applyFilters);

    const presetCategoryId = document.getElementById('presetCategoryId');
    if (presetCategoryId && category) {
      const v = presetCategoryId.value;
      if (v) {
        category.value = v;
        applyFilters();
      }
    }

    const catSelect = document.getElementById('furnitureCategorySelect');
    const subSelect = document.getElementById('furnitureSubCategorySelect');
    const sizeSelect = document.getElementById('furnitureSizeSelect');
    const furnitureModalEl = document.getElementById('furnitureModal');
    const modalTitle = document.getElementById('furnitureModalTitle');
    const submitBtn = document.getElementById('furnitureSubmitBtn');
    const itemIdInput = document.getElementById('furnitureItemId');
    const nameInput = document.getElementById('furnitureNameInput');
    const materialSelect = document.getElementById('furnitureMaterialSelect');
    const qtyInput = document.getElementById('furnitureQtyInput');
    const costInput = document.getElementById('furnitureCostInput');
    const saleInput = document.getElementById('furnitureSaleInput');
    const notesInput = document.getElementById('furnitureNotesInput');
    const imgFileInput = document.getElementById('furnitureImageFile');
    const imgUrlInput = document.getElementById('furnitureImageUrl');

    function filterSubs() {
      if (!catSelect || !subSelect) return;
      const parentId = catSelect.value;
      for (const opt of Array.from(subSelect.options)) {
        if (!opt.value) continue;
        const p = opt.getAttribute('data-parent-id');
        opt.hidden = !!parentId && p !== parentId;
      }
      if (subSelect.selectedOptions.length && subSelect.selectedOptions[0].hidden) {
        subSelect.value = '';
      }
    }

    function ensureDefaults() {
      const presetCategoryId = document.getElementById('presetCategoryId');
      if (presetCategoryId && catSelect) {
        const v = presetCategoryId.value;
        if (v) catSelect.value = v;
      }
      if (catSelect && !catSelect.value) {
        const first = Array.from(catSelect.options).find((o) => !!o.value);
        if (first) catSelect.value = first.value;
      }
      filterSubs();
      if (sizeSelect && !sizeSelect.value) {
        const first = Array.from(sizeSelect.options).find((o) => !!o.value);
        if (first) sizeSelect.value = first.value;
      }
    }

    function setMode(mode) {
      if (!modalTitle || !submitBtn) return;
      if (mode === 'edit') {
        modalTitle.textContent = 'Edit Furniture';
        submitBtn.textContent = 'Save Changes';
      } else {
        modalTitle.textContent = 'Add Furniture';
        submitBtn.textContent = 'Add Furniture';
      }
    }

    function resetFormForAdd() {
      setMode('add');
      if (itemIdInput) itemIdInput.value = '';
      if (nameInput) nameInput.value = '';
      if (materialSelect) materialSelect.value = 'Wood';
      if (qtyInput) qtyInput.value = '0';
      if (costInput) costInput.value = '0';
      if (saleInput) saleInput.value = '0';
      if (notesInput) notesInput.value = '';
      if (imgUrlInput) imgUrlInput.value = '';
      if (imgFileInput) imgFileInput.value = '';
      ensureDefaults();
    }

    function fillFormForEdit(btn) {
      setMode('edit');
      if (itemIdInput) itemIdInput.value = btn.getAttribute('data-item-id') || '';
      if (nameInput) nameInput.value = btn.getAttribute('data-name') || '';
      if (catSelect) catSelect.value = btn.getAttribute('data-category-id') || '';
      filterSubs();
      if (subSelect) subSelect.value = btn.getAttribute('data-sub-category-id') || '';

      const bs = btn.getAttribute('data-bed-size-id') || '';
      if (sizeSelect) sizeSelect.value = (bs === 'None' || bs === 'null' || bs === '') ? 'custom' : bs;
      if (materialSelect) materialSelect.value = btn.getAttribute('data-material-type') || 'Wood';
      if (qtyInput) qtyInput.value = btn.getAttribute('data-qty-on-hand') || '0';
      if (costInput) costInput.value = btn.getAttribute('data-cost-price-pkr') || '0';
      if (saleInput) saleInput.value = btn.getAttribute('data-sale-price-pkr') || '0';
      if (imgUrlInput) imgUrlInput.value = btn.getAttribute('data-image-url') || '';
      if (imgFileInput) imgFileInput.value = '';
      if (notesInput) notesInput.value = btn.getAttribute('data-notes') || '';
    }

    if (catSelect) catSelect.addEventListener('change', filterSubs);

    if (furnitureModalEl) {
      furnitureModalEl.addEventListener('show.bs.modal', function (evt) {
        const btn = evt.relatedTarget;
        const isEdit = btn && btn.getAttribute && btn.getAttribute('data-mode') === 'edit';
        if (isEdit) {
          fillFormForEdit(btn);
        } else {
          resetFormForAdd();
        }
      });

      furnitureModalEl.addEventListener('shown.bs.modal', function () {
        if (nameInput) nameInput.focus();
      });
    }

    const adjustModal = document.getElementById('stockAdjustModal');
    if (adjustModal) {
      adjustModal.addEventListener('show.bs.modal', function (evt) {
        const btn = evt.relatedTarget;
        if (!btn) return;
        const variantId = btn.getAttribute('data-variant-id') || '';
        const itemName = btn.getAttribute('data-item-name') || '';
        const currentQty = btn.getAttribute('data-current-qty') || '0';
        const invType = btn.getAttribute('data-inventory-type') || '';

        document.getElementById('stockAdjustVariantId').value = variantId;
        document.getElementById('stockAdjustInventoryType').value = invType;
        document.getElementById('stockAdjustItemName').textContent = itemName;
        document.getElementById('stockAdjustCurrentQty').textContent = currentQty;

        const qtyInput = document.getElementById('stockAdjustQty');
        if (qtyInput) qtyInput.value = '';
        const preview = document.getElementById('stockAdjustPreview');
        if (preview) {
          preview.classList.add('d-none');
          preview.textContent = '';
        }
      });

      function updatePreview() {
        const currentQty = parseInt(document.getElementById('stockAdjustCurrentQty').textContent || '0');
        const qty = parseInt(document.getElementById('stockAdjustQty').value || '0');
        const isOut = document.getElementById('stockOut').checked;
        const preview = document.getElementById('stockAdjustPreview');
        if (!preview) return;
        if (!qty) {
          preview.classList.add('d-none');
          preview.textContent = '';
          return;
        }
        const next = isOut ? (currentQty - qty) : (currentQty + qty);
        preview.classList.remove('d-none');
        preview.classList.remove('bg-success-subtle', 'text-success-emphasis', 'bg-warning-subtle', 'text-warning-emphasis');
        if (isOut) {
          preview.classList.add('bg-warning-subtle', 'text-warning-emphasis');
        } else {
          preview.classList.add('bg-success-subtle', 'text-success-emphasis');
        }
        preview.innerHTML = 'New stock will be: <span class="fs-5 fw-bold">' + next + '</span>';
      }

      document.getElementById('stockAdjustQty').addEventListener('input', updatePreview);
      document.getElementById('stockIn').addEventListener('change', updatePreview);
      document.getElementById('stockOut').addEventListener('change', updatePreview);
    }
  })();
</script>
{% endblock %}
