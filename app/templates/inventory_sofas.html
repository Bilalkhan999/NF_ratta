{% extends "base.html" %}

{% block content %}
<div class="d-flex flex-column flex-sm-row justify-content-between gap-3 mb-4">
  <div>
    <h1 class="h3 fw-bold mb-1">Sofa Inventory</h1>
    <div class="text-secondary">Manage sofa items and stock</div>
  </div>
  <button class="btn btn-primary btn-lg" type="button" data-bs-toggle="modal" data-bs-target="#sofaModal" data-mode="add">
    Add Sofa
  </button>
</div>

<div class="row g-3 align-items-end mb-4">
  <div class="col-12 col-md-8">
    <label class="form-label">Search</label>
    <input id="sofaSearch" class="form-control form-control-lg" placeholder="Search sofas..." />
  </div>
  <div class="col-12 col-md-4">
    <label class="form-label">Type</label>
    <select id="sofaTypeFilter" class="form-select form-select-lg">
      <option value="all">All Types</option>
      {% for t in sofa_types %}
        <option value="{{ t }}">{{ t }}</option>
      {% endfor %}
    </select>
  </div>
</div>

{% if cards|length == 0 %}
  <div class="card p-5 text-center">
    <div class="h5 fw-semibold mb-1">No sofas found</div>
    <div class="text-secondary mb-3">Get started by adding your first sofa item</div>
    <button class="btn btn-primary" type="button" data-bs-toggle="modal" data-bs-target="#sofaModal" data-mode="add">Add Sofa</button>
  </div>
{% else %}
  <div class="row g-3" id="sofaGrid">
    {% for c in cards %}
      {% set it = c.item %}
      <div class="col-12 col-md-6 col-xl-4 sofa-card"
           data-sofa-type="{{ it.sofa_type }}"
           data-search="{{ (it.name ~ ' ' ~ it.sofa_type ~ ' ' ~ (it.hardware_material or '') ~ ' ' ~ (it.poshish_material or ''))|lower }}">
        <div class="card hover-elevate">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <div class="me-3" style="min-width: 0;">
                <div class="fw-semibold fs-5 text-truncate">{{ it.name }}</div>
                <div class="text-secondary small">{{ it.sofa_type }}{% if it.seating_capacity %} â€¢ {{ it.seating_capacity }}{% endif %}</div>
              </div>
              <span class="badge rounded-pill {{ c.badge_class }}">{{ c.badge }}</span>
            </div>

            <div class="small">
              <div class="d-flex justify-content-between py-1">
                <span class="text-secondary">Hardware:</span>
                <span class="text-truncate" style="max-width: 60%;">{{ it.hardware_material or '-' }}</span>
              </div>
              <div class="d-flex justify-content-between py-1">
                <span class="text-secondary">Poshish:</span>
                <span class="text-truncate" style="max-width: 60%;">{{ it.poshish_material or '-' }}</span>
              </div>
              <div class="d-flex justify-content-between py-1">
                <span class="text-secondary">Quantity:</span>
                <span class="fw-semibold">{{ it.qty_on_hand }}</span>
              </div>
              <div class="d-flex justify-content-between py-1">
                <span class="text-secondary">Cost:</span>
                <span>Rs. {{ '{:,}'.format(it.cost_price_pkr or 0) }}</span>
              </div>
              <div class="d-flex justify-content-between py-1">
                <span class="text-secondary">Selling:</span>
                <span class="fw-bold text-primary">Rs. {{ '{:,}'.format(it.sale_price_pkr or 0) }}</span>
              </div>
            </div>

            <div class="d-flex flex-wrap gap-2 mt-3">
              <button
                class="btn btn-outline-secondary flex-grow-1"
                type="button"
                data-bs-toggle="modal"
                data-bs-target="#stockAdjustModal"
                data-variant-id="{{ it.id }}"
                data-item-name="{{ it.name }}"
                data-current-qty="{{ it.qty_on_hand }}"
                data-inventory-type="SOFA_ITEM"
              >
                Adjust Stock
              </button>

              <button
                class="btn btn-outline-secondary"
                type="button"
                data-bs-toggle="modal"
                data-bs-target="#sofaModal"
                data-mode="edit"
                data-item-id="{{ it.id }}"
                data-name="{{ it.name }}"
                data-sofa-type="{{ it.sofa_type }}"
                data-hardware-material="{{ it.hardware_material or '' }}"
                data-poshish-material="{{ it.poshish_material or '' }}"
                data-seating-capacity="{{ it.seating_capacity or '' }}"
                data-qty-on-hand="{{ it.qty_on_hand }}"
                data-cost-price-pkr="{{ it.cost_price_pkr or 0 }}"
                data-sale-price-pkr="{{ it.sale_price_pkr or 0 }}"
                data-notes="{{ it.notes or '' }}"
              >
                Edit
              </button>

              <form method="post" action="/inventory/sofas/{{ it.id }}/delete" class="m-0">
                <button class="btn btn-outline-danger" type="submit">Delete</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
{% endif %}

<div class="modal fade" id="sofaModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="sofaModalTitle">Add Sofa</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="/inventory/sofas">
        <input type="hidden" name="item_id" id="sofaItemId" />
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label">Name</label>
              <input class="form-control form-control-lg" name="name" id="sofaNameInput" required />
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Sofa Type</label>
              <input class="form-control form-control-lg" name="sofa_type" id="sofaTypeInput" required />
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Seating Capacity</label>
              <input class="form-control form-control-lg" name="seating_capacity" id="sofaCapacityInput" placeholder="e.g. 3 Seater" />
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Hardware Material</label>
              <input class="form-control form-control-lg" name="hardware_material" id="sofaHardwareInput" placeholder="e.g. Hinges" />
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Poshish Material</label>
              <input class="form-control form-control-lg" name="poshish_material" id="sofaPoshishInput" placeholder="e.g. Fiber" />
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">Quantity</label>
              <input class="form-control form-control-lg" type="number" name="qty_on_hand" id="sofaQtyInput" value="0" min="0" />
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">Cost Price (PKR)</label>
              <input class="form-control form-control-lg" type="number" name="cost_price_pkr" id="sofaCostInput" value="0" min="0" />
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">Selling Price (PKR)</label>
              <input class="form-control form-control-lg" type="number" name="sale_price_pkr" id="sofaSaleInput" value="0" min="0" />
            </div>
            <div class="col-12">
              <label class="form-label">Notes</label>
              <textarea class="form-control" name="notes" id="sofaNotesInput" rows="3"></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary btn-lg" id="sofaSubmitBtn">Add Sofa</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="stockAdjustModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Adjust Stock</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="/inventory/stock/adjust">
        <div class="modal-body">
          <input type="hidden" name="inventory_type" id="stockInventoryType" />
          <input type="hidden" name="variant_id" id="stockVariantId" />

          <div class="mb-2 fw-semibold" id="stockItemName"></div>
          <div class="text-secondary small mb-3">Current qty: <span id="stockCurrentQty"></span></div>

          <div class="row g-3">
            <div class="col-12">
              <label class="form-label">Transaction</label>
              <select class="form-select form-select-lg" name="transaction_type" id="stockTxnType">
                <option value="in">Stock In</option>
                <option value="out">Stock Out</option>
              </select>
            </div>
            <div class="col-12">
              <label class="form-label">Quantity</label>
              <input class="form-control form-control-lg" type="number" name="quantity" id="stockQty" min="1" required />
            </div>
            <div class="col-12">
              <label class="form-label">Notes</label>
              <textarea class="form-control" name="notes" rows="3"></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary btn-lg">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
(function () {
  const searchEl = document.getElementById('sofaSearch');
  const typeFilterEl = document.getElementById('sofaTypeFilter');
  const gridEl = document.getElementById('sofaGrid');

  function applyFilters() {
    if (!gridEl) return;
    const q = (searchEl && searchEl.value ? searchEl.value : '').trim().toLowerCase();
    const t = typeFilterEl ? typeFilterEl.value : 'all';

    const cards = gridEl.querySelectorAll('.sofa-card');
    cards.forEach((el) => {
      const s = (el.getAttribute('data-search') || '');
      const ty = (el.getAttribute('data-sofa-type') || '');
      const matchQ = !q || s.includes(q);
      const matchT = t === 'all' || ty === t;
      el.style.display = (matchQ && matchT) ? '' : 'none';
    });
  }

  if (searchEl) searchEl.addEventListener('input', applyFilters);
  if (typeFilterEl) typeFilterEl.addEventListener('change', applyFilters);

  const modalEl = document.getElementById('sofaModal');
  const titleEl = document.getElementById('sofaModalTitle');
  const submitBtn = document.getElementById('sofaSubmitBtn');

  const itemIdEl = document.getElementById('sofaItemId');
  const nameEl = document.getElementById('sofaNameInput');
  const typeEl = document.getElementById('sofaTypeInput');
  const hardwareEl = document.getElementById('sofaHardwareInput');
  const poshishEl = document.getElementById('sofaPoshishInput');
  const capEl = document.getElementById('sofaCapacityInput');
  const qtyEl = document.getElementById('sofaQtyInput');
  const costEl = document.getElementById('sofaCostInput');
  const saleEl = document.getElementById('sofaSaleInput');
  const notesEl = document.getElementById('sofaNotesInput');

  function setMode(isEdit) {
    if (!titleEl || !submitBtn) return;
    titleEl.textContent = isEdit ? 'Edit Sofa' : 'Add Sofa';
    submitBtn.textContent = isEdit ? 'Save Changes' : 'Add Sofa';
  }

  function resetForm() {
    if (itemIdEl) itemIdEl.value = '';
    if (nameEl) nameEl.value = '';
    if (typeEl) typeEl.value = '';
    if (hardwareEl) hardwareEl.value = '';
    if (poshishEl) poshishEl.value = '';
    if (capEl) capEl.value = '';
    if (qtyEl) qtyEl.value = '0';
    if (costEl) costEl.value = '0';
    if (saleEl) saleEl.value = '0';
    if (notesEl) notesEl.value = '';
    setMode(false);
  }

  function fillForEdit(btn) {
    if (!btn) return;
    if (itemIdEl) itemIdEl.value = btn.getAttribute('data-item-id') || '';
    if (nameEl) nameEl.value = btn.getAttribute('data-name') || '';
    if (typeEl) typeEl.value = btn.getAttribute('data-sofa-type') || '';
    if (hardwareEl) hardwareEl.value = btn.getAttribute('data-hardware-material') || '';
    if (poshishEl) poshishEl.value = btn.getAttribute('data-poshish-material') || '';
    if (capEl) capEl.value = btn.getAttribute('data-seating-capacity') || '';
    if (qtyEl) qtyEl.value = btn.getAttribute('data-qty-on-hand') || '0';
    if (costEl) costEl.value = btn.getAttribute('data-cost-price-pkr') || '0';
    if (saleEl) saleEl.value = btn.getAttribute('data-sale-price-pkr') || '0';
    if (notesEl) notesEl.value = btn.getAttribute('data-notes') || '';
    setMode(true);
  }

  if (modalEl) {
    modalEl.addEventListener('show.bs.modal', function (evt) {
      const btn = evt.relatedTarget;
      const isEdit = btn && btn.getAttribute && btn.getAttribute('data-mode') === 'edit';
      if (isEdit) {
        fillForEdit(btn);
      } else {
        resetForm();
      }
    });
    modalEl.addEventListener('shown.bs.modal', function () {
      if (nameEl) nameEl.focus();
    });
  }

  const stockModalEl = document.getElementById('stockAdjustModal');
  if (stockModalEl) {
    stockModalEl.addEventListener('show.bs.modal', function (evt) {
      const btn = evt.relatedTarget;
      if (!btn) return;
      const inv = btn.getAttribute('data-inventory-type') || '';
      const vid = btn.getAttribute('data-variant-id') || '';
      const nm = btn.getAttribute('data-item-name') || '';
      const cq = btn.getAttribute('data-current-qty') || '';

      const invEl = document.getElementById('stockInventoryType');
      const vidEl = document.getElementById('stockVariantId');
      const nmEl = document.getElementById('stockItemName');
      const cqEl = document.getElementById('stockCurrentQty');
      const qtyEl2 = document.getElementById('stockQty');
      const txnEl = document.getElementById('stockTxnType');

      if (invEl) invEl.value = inv;
      if (vidEl) vidEl.value = vid;
      if (nmEl) nmEl.textContent = nm;
      if (cqEl) cqEl.textContent = cq;
      if (qtyEl2) qtyEl2.value = '';
      if (txnEl) txnEl.value = 'in';
    });
  }
})();
</script>
{% endblock %}
